jQuery(n=>{const e=n(document.body);const t=debounce(function(){const e=n(this),t=e.closest("table");const s=t.children("tbody").filter(":visible").children().children(".check-column").find(":checkbox:checked").length;if(s){n("#box-update-status").show()}else{n("#box-update-status").hide()}},20);e.on("click","table.pp-shipments .check-column :checkbox",t);new PPVue({el:"#pp-app",data(){return{parcelpanel:parcelpanel_param,pageParam:pp_param,checked:false,isOpenExportModal:false,isOpenModal:false,isExporting:false,totalShipments:total_items,exportStep:1,exportPercentage:0,exportFileName:"",showPostLayer:false,postLayerShowTimer:null,route:{fullPath:"",hash:"",query:{},path:"",href:""}}},created(){window.onbeforeunload=()=>{if(this.isExporting){return true}};this.postLayerShowTimer=setTimeout(()=>{this.showPostLayer=true},1e4);this.parseRoute();window.onhashchange=()=>{this.parseRoute()}},mounted(){n("#re-sync-submit").on("click",()=>{this.onResync();return false})},methods:{parseRoute(){const e=window.location.hash;const t=e.replace(/^#/,"");let s=t;const a=s.indexOf("#");if(a!==-1){this.route.hash=s.substring(a);s=s.substring(0,a)}const r=s.indexOf("?");if(r!==-1){s=s.substring(0,r)}const o=s;this.route={...this.route,fullPath:t,path:o,href:e};if(o==="/import-tracking"){document.querySelector("#screen-meta-links").style.display="none"}else{document.querySelector("#screen-meta-links").style.display="block"}},onExportShipments(){if(this.isExporting){return}this.isExporting=true;const e=new Date,t=e.getDate(),s=e.getMonth()+1,a=e.getFullYear(),r=e.getTime();this.exportFileName=`parcelpanel-export-shipments-${t}-${s}-${a}-${r}.csv`;this.exportStep=1;this.exportPercentage=0;this.processExport()},processExport(){n.ajax({type:"POST",url:ajaxurl+location.search,data:{action:"pp_export_csv",_ajax_nonce:this.pageParam.export_nonce,filename:this.exportFileName,step:this.exportStep},success:e=>{if(false===e.success){this.isExporting=false;n.toastr.error(e.msg||"Upload failed! Unknown error");return}this.exportStep=e.data.step;this.exportPercentage=e.data.percentage;if(100===e.data.percentage){setTimeout(()=>{this.isExporting=false;this.isOpenExportModal=false;this.$nextTick(()=>{window.location=e.data.download_link})},1e3);return}setTimeout(()=>{this.processExport()},500)},error:()=>{this.isExporting=false;n.toastr.error("Server error, please try again or refresh the page")}})},onResync(e){const t=n("#resync-time");const s=n("#re-sync-submit");const a=t.val();if(!a){n.toastr.error("Please select sync time.");return}t.attr("disabled","disabled");s.attr("disabled","disabled");n.ajax({type:"POST",url:ajaxurl,data:{action:"pp_resync",_ajax_nonce:this.pageParam.resync_nonce,sync:a},success:e=>{t.removeAttr("disabled");s.removeAttr("disabled");if(e.success){n.toastr.success(e.msg)}else{n.toastr.error(e.msg)}},error:()=>{n.toastr.error("Server error, please try again or refresh the page")}})},handlePostLayerShow(e){this.postLayerShowTimer&&clearTimeout(this.postLayerShowTimer);this.showPostLayer=e},handleImportTrackingNumberButtonClick(){window.location.hash="#/import-tracking"}}});n("#update-status-submit").on("click",()=>{const r=()=>{n("table.pp-shipments .check-column :checkbox").removeAttr("disabled");n("#select-update-status").removeAttr("disabled");n("#update-status-submit").removeAttr("disabled")};const e=()=>{n("table.pp-shipments .check-column :checkbox").attr("disabled","disabled");n("#select-update-status").attr("disabled","disabled");n("#update-status-submit").attr("disabled","disabled")};const o=(e=true)=>{n("table.pp-shipments tbody .check-column :checkbox:checked").parent().parent("tr").toggleClass("loading",e)};const t=n("#select-update-status").val();const s=[];n("table.pp-shipments tbody .check-column :checkbox:checked").each(function(){s.push(n(this).val())});if(!s.length||!t){return false}e();o();const a={shipments:s,update_status:t};n.ajax({method:"POST",url:`${ajaxurl}?action=pp_change_custom_order_status&_ajax_nonce=${pp_param.ajax_nonce}`,contentType:"application/json",data:JSON.stringify(a),success:e=>{if(!e.success){n.toastr.error(e.msg||"Updated failed",{time:3e3});r();o(false);return}let t,s;let a;if(e.data.updated_orders.length){i({updated_orders:e.data.updated_orders});a=2500}else{a=0}t=setTimeout(()=>{if(e.success){n.toastr.success("Updated successfully")}else{n.toastr.error("Server error, please try again or refresh the page")}},a);s=setTimeout(()=>{window.location.reload()},a+500)},error(){n.toastr.error("Server error, please try again or refresh the page");r();o(false)}});return false});function i(e){n.ajax({method:"POST",url:`${ajaxurl}?action=pp_updated_orders_send_email&_ajax_nonce=${pp_param.ajax_nonce}`,contentType:"application/json",data:JSON.stringify(e)})}});