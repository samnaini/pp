(O=>{O(()=>{const i=5;const t=O("#pp-tk-btn-show-form"),e=O("#pp-mdl-import"),a=e.find(".back"),n=O("#pp-pnl-upload"),s=O("#pp-upload-progress"),o=s.find(".percent"),r=s.find(".progress-bar"),d=n.find(".box-import-records"),l=n.find(".lst-records"),c=O("#pp-pnl-record-detail"),p=c.find(".filename"),m=c.find(".total"),_=c.find(".succeeded"),u=c.find(".failed"),f=c.find(".details"),h=n.find(".pp-ipt-upload-wrapper"),g=O("#pp-ipt-upload-file"),b=e.find(".modal-close"),v=e.find(".btn-import");const k=O(".edit-php.post-type-shop_order"),w=k.find(".page-title-action:first");let x=[];let y=false;let $=0;O("<a/>",{class:"page-title-action",href:parcelpanel_admin.urls.import_tracking_number,text:parcelpanel_admin.strings.import_tracking_number}).insertAfter(w);const j=e=>{return`<div class="pp-number-input"><input max="${e.max_value}" data-item-id="${e.id}" value="${e.value}" autocomplete="off" ${e.is_editable?"":"disabled"} min="0" type="number" class="pp-number-input-input item-quantity" data-v-ubw820r6><div class="pp-number-input-suffix">of ${e.max_value}</div></div>`};const S={is_open_modal:false,order_id:0,tracking_id:0,tracking_number:"",courier_code:"",fulfilled_date:"",is_saving:false,line_items:[],shipments:[],has_full_shipped:false,refresh_page_after_saved:false,init:function(){O("#pp-wc-shop_order-shipment-tracking").on("click",".delete-tracking",this.delete_tracking).on("click","#pp-tk-btn-show-form",this.show_form_click).on("click",".edit-tracking",this.edit_tracking);k.on("click",".parcelpanel_add_tracking",this.handle_admin_order_actions_add_track_click)},handle_admin_order_actions_add_track_click:function(e){e.preventDefault();if(!e.target||e.target.getAttribute("disabled")){return}const t=parseInt((e.target.href||"").split("#")[1]);if(!t){return}k.find(".parcelpanel_add_tracking").attr("disabled","disabled");S.refresh_page_after_saved=true;S.tracking_id=0;S.tracking_number="";S.courier_code="";S.fulfilled_date="";S.order_id=t;S.show_form().finally(()=>{k.find(".parcelpanel_add_tracking").removeAttr("disabled")})},edit_tracking:function(){const e=O(this).closest("li.tracking-item");const t=e.data("tracking-id");const a=e.find(".number").text();const i=e.find(".courier").data("value");const n=e.data("fulfilled-date");S.tracking_id=t;S.tracking_number=a;S.courier_code=i;S.fulfilled_date=n;S.order_id=parseInt(parcelpanel_admin_wc_meta_boxes.post_id);S.show_form()},show_form_click:function(){t.attr("disabled","disabled").addClass("is-busy");S.tracking_id=0;S.tracking_number="";S.courier_code="";S.fulfilled_date="";S.order_id=parseInt(parcelpanel_admin_wc_meta_boxes.post_id);S.show_form().finally(()=>{t.removeAttr("disabled").removeClass("is-busy")})},req_get_tracking_items:()=>{const e=`${ajaxurl}?action=pp_get_tracking_items&order_id=${S.order_id}&_ajax_nonce=${parcelpanel_admin_wc_meta_boxes.get_shipment_item_nonce}`;return fetch(e).then(e=>e.json()).catch(e=>{O.toastr.error("Server error, please try again or refresh the page");return e})},refresh_meta_box_shipments(){if(!window.parcelpanel_admin_wc_meta_boxes_shipments)return;S.req_get_tracking_items().then(e=>{window.parcelpanel_admin_wc_meta_boxes_shipments.shipments=e.data.shipments;S.render_shipment_items();return e})},show_form:function(){return S.req_get_tracking_items().then(e=>{S.line_items=e.data.line_items;S.shipments=e.data.shipments;S.order_number=e.data.order_number;if(window.parcelpanel_admin_wc_meta_boxes_shipments){window.parcelpanel_admin_wc_meta_boxes_shipments.shipments=e.data.shipments;S.render_shipment_items()}S.render_add_tracking_modal();return e})},render_shipment_items:function(){const e=window.parcelpanel_admin_wc_meta_boxes_shipments.shipments.map((e,t)=>{return`<li class="tracking-item" data-fulfilled-date="${e.fulfilled_date}" data-tracking-id="${e.id}" id="pp-tracking-item-${e.id}"><div style="display:flex;margin-bottom:8px;justify-content:space-between;"><div>Shipment ${t+1}</div><div><a class="edit-tracking">Edit</a><a class="delete-tracking">Delete</a></div></div><div class="tracking-content"><div class="tracking-number"><strong class="courier" data-value="${e.courier_code}">${e.courier_name}</strong> - <a class="number" href="${e.tracking_url}" target="_blank" title="Tracking order">${e.tracking_number}</a></div><div class="tracking-status"><span class="pp-tracking-icon icon-${e.shipment_status_label}">${e.shipment_status_text}</span></div><div class="tracking-info"></div></div><p class="meta"><span class="fulfilled_on">${e.shipped_on_text}</span></p></li>`});O("#pp-tk-tracking-items").html(e.join(""));t.removeAttr("disabled")},render_add_tracking_modal:function(){if(S.is_open_modal){return}S.is_open_modal=true;const e=window.parcelpanel_admin_wc_meta_boxes.i18n;const t=S.line_items;let f=S.tracking_id;const a=S.shipments.some(e=>e.ship_type===1);const i=!!f;const n=new Set(S.shipments.map(({line_items:e})=>e.filter(({quantity:e})=>!e).map(({id:e})=>e)).flat());const s=S.shipments.find(e=>e.tracking_id===f)||{};const{ship_type:h=0}=s;const o=f?e.edit_tracking:e.add_tracking;const r=f?e.save:e.add;const d=S.order_number;const l={};s.line_items?.forEach(e=>{l[e.id]=(l[e.id]??0)+e.quantity});const c=h===1;const p=t.map(e=>{let t=e.remain_quantity;let a=i?l[e.id]??0:t;if(i){t+=l[e.id]??0}if(l[e.id]!==0&&!t){return}return{...e,value:l[e.id]===0?e.quantity:a,max_value:l[e.id]===0?e.quantity:t,is_editable:!n.has(e.id)}}).filter(e=>e);const m=()=>{return p.map(e=>`<tr><td><div class="thumb">${e.image_url?`<img src="${e.image_url}" alt>`:""}</div></td><td class="column-name">${e.name}</td><td>${j(e)}</td></tr>`).join("")};const _=()=>{return(window.parcelpanel_courier_list||{}).map(e=>{return{id:e.code,text:e.name,selected:e.code===s.courier_code}})};let{tracking_number:u,courier_code:g,fulfilled_date:b}=S;const v=a||!p.length;const k=!f&&v;let w=!c?!v?`<table class="pp-items"><thead><tr><th class="column-items">Items</th><th>Qty.</th></tr></thead><tbody>${m()}</tbody></table>`:`<div class="fulfilled-tip">All items have been fulfilled</div>`:"";if(w){w+='<hr class="pp-divider">'}O(document.body).append(`<div id="PP-Modal-UVSNWm" class="components-modal__screen-overlay pp-modal">
<style>
.pp-items{display:grid;text-align:left;grid-template-columns:auto 1fr auto;column-gap:10px;row-gap:6px}
.pp-items thead,.pp-items tbody,.pp-items tr{display:contents;}
.pp-items th{margin-bottom:8px;}
.pp-items th.column-items{grid-column:1/span 2}
.pp-items .column-name{align-self:center}
.pp-items .thumb{position:relative;display:block;width:38px;height:38px;border:2px solid #e8e8e8;background:#f8f8f8;color:#ccc;text-align:center;font-size:21px}
.pp-items .thumb:before{position:absolute;top:0;left:0;display:block;margin:0;width:100%;height:100%;content:"\\f128";text-align:center;text-indent:0;text-transform:none;font-weight:400;font-variant:normal;font-family:Dashicons;line-height:38px;speak:never;-webkit-font-smoothing:antialiased}
.pp-items .thumb img{position:relative;margin:0;padding:0;width:100%;height:100%}
.pp-modal th:last-child,.pp-modal td:last-child{text-align:right;}

.pp-divider{margin:20px 0;height:0;border:solid #ddd;border-width:0 0 1px;}

.pp-input-box{display:grid;color:#3c434a;column-gap:20px;grid-template-columns:1fr 1fr;row-gap:12px}
.pp-input-box label{display:flex;flex-direction:column;}

.fulfilled-tip{color:#999c9f;text-align:center;font-size:16px}

.pp-number-input{display:inline-flex;overflow:hidden;border:1px solid #8c8f94;border-radius:4px;background:#f1f1f1;align-items:center}
input.pp-number-input-input[data-v-ubw820r6]{margin:0;padding:0 0 0 8px;width:100%;outline:0!important;border:0!important;border-radius:0;box-shadow:none!important}
.pp-number-input-suffix{margin:0 8px;color:#646970;flex:0 0 auto}
@-moz-document url-prefix() {
.pp-number-input{background:0 0}
}
</style>
<div role="dialog" tabindex="-1" class="components-modal__frame">
  <div role="document" class="components-modal__content" style="display:flex;flex-direction:column">
    <div class="components-modal__header">
      <div class="components-modal__header-heading-container"><h1 class="components-modal__header-heading">${o} - #${d}</h1></div>
      <button type="button" id="pp-tk-modal-close" aria-label="Close dialog" class="components-button has-icon" style="position:unset;margin-right:-8px;width:36px;">
        <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M11.414 10l6.293-6.293a1 1 0 10-1.414-1.414L10 8.586 3.707 2.293a1 1 0 00-1.414 1.414L8.586 10l-6.293 6.293a1 1 0 101.414 1.414L10 11.414l6.293 6.293A.998.998 0 0018 17a.999.999 0 00-.293-.707L11.414 10z" fill="#5C5F62"></path></svg>
      </button>
    </div>
    <div class="pp-modal-body">
${w}

<div class="pp-input-box">

<div><label>${e.tracking_number}<input type="text" id="pp-tk-ipt-tracking-number" value="${u}"></label></div>

<div><label>${e.courier}<select id="pp-tk-slc-courier"><option value>${e.auto_matching}</option></select></label></div>

<div><label>${e.mark_order_as}<select id="pp-tk-slc-mark-order-as" data-minimum-results-for-search="-1" data-placeholder="None" data-allow-clear="true"><option></option></select></label></div>

<div><label>${e.date_shipped}<input type="text" id="pp-tk-ipt-date-shipped" class="date-picker-field" value="${b}" placeholder="${window.parcelpanel_admin_wc_meta_boxes.today}"></label></div>

</div>
    </div>
  </div>

<div class="components-modal__footer">
<button type="button" class="components-button pp-button is-primary" id="pp-tk-btn-ok" ${k?"disabled":""}>
<span>${r}</span>
</button>
</div>

</div>
</div>`);O("#PP-Modal-UVSNWm #pp-tk-slc-courier").selectWoo({data:_(),width:"auto"});O("#PP-Modal-UVSNWm #pp-tk-slc-mark-order-as").selectWoo({data:window.parcelpanel_admin_wc_meta_boxes.mark_order_as_select_list,width:"auto"});O(document.body).trigger("wc-init-datepickers");O("#PP-Modal-UVSNWm").on("click","#pp-tk-modal-close",S.close_add_tracking_modal).on("click","#pp-tk-btn-ok",()=>{const{save_shipment_item_nonce:e}=window.parcelpanel_admin_wc_meta_boxes;const{order_id:t}=S;const a=O("#pp-tk-ipt-tracking-number");const i=O("#pp-tk-ipt-date-shipped");const n=O("#pp-tk-slc-courier");const s=O("#pp-tk-slc-mark-order-as");let o=false;if(a.val()===""){V(a);o=true}else{z(a)}if(o)return;const r=[];if(h!==1){O(".item-quantity").each((e,t)=>{const a=parseInt(O(t).data("item-id"));const i=parseInt(O(t).val());if(a&&i>0){r.push({id:a,quantity:i})}});if(!r.length){O.toastr.warning("Empty line items");return}}const d=i.datepicker("getDate")||new Date,l=d.getDate(),c=d.getMonth()+1,p=d.getFullYear();const m={order_id:t,mark_order_as:s.val(),tracking_id:f,tracking_number:a.val(),courier_code:n.val(),fulfilled_date:`${p}-${c}-${l}`,line_items:r};const _=["mark_order_as","tracking_id","courier_code"];_.map(e=>{m[e]=m[e]||undefined});const u=`${ajaxurl}?action=pp_shipment_item_save&_ajax_nonce=${e}`;if(S.is_saving)return;S.is_saving=true;O("#pp-tk-btn-ok").attr("disabled","disabled").addClass("is-busy");fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}).then(e=>e.json()).then(e=>{if(!e.success){O.toastr.warning(e.msg||"Unknown error!");return}O.toastr.success("Saved successfully");if(S.refresh_page_after_saved){window.location.reload();return}S.refresh_meta_box_shipments();S.close_add_tracking_modal();if(["completed","partial-shipped"].includes(s.val())){O("#order_status").val(`wc-${s.val()}`).trigger("change");O("#post").before('<div id="order_updated_message" class="updated notice notice-success is-dismissible"><p>Order updated.</p><button type="button" class="notice-dismiss update-dismiss"><span class="screen-reader-text">Dismiss this notice.</span></button></div>')}}).catch(()=>{O.toastr.error("Server error, please try again or refresh the page")}).finally(()=>{O("#pp-tk-btn-ok").removeAttr("disabled").removeClass("is-busy");S.is_saving=false})})},close_add_tracking_modal:()=>{O("#PP-Modal-UVSNWm").remove();S.is_open_modal=false},delete_tracking:function(){const n=O(this).closest("li.tracking-item");const s=n.data("tracking-id");E(parcelpanel_admin_wc_meta_boxes.i18n_delete_tracking,"Delete tracking number",e=>{if(!e){return}n.block({message:null,overlayCSS:{background:"#fff",opacity:.6}});const{post_id:t,delete_shipment_item_nonce:a}=window.parcelpanel_admin_wc_meta_boxes;const i={action:"pp_delete_tracking_item",order_id:t,tracking_id:s,_ajax_nonce:a};O.post(woocommerce_admin_meta_boxes.ajax_url,i,e=>{n.unblock();S.order_id=t;S.refresh_meta_box_shipments();if(e.success){n.remove();O.toastr.success(e.msg)}else{O.toastr.error(e.msg)}})});return false}};S.init();if(window.parcelpanel_admin_wc_meta_boxes_shipments){S.render_shipment_items()}O(".pp-tips").tipTip();v.on("click",()=>{N(g[0])});b.on("click",()=>{P()});a.on("click",()=>{D()});l.on("click",".view",function(){const t=parseInt(O(this).data("id"));const e=x.find(e=>{return e.id===t});if(e){L(e)}});O(window).bind("beforeunload",()=>{if(y){return true}});function U(){if(!x.length){I()}D();e.show()}function P(){e.hide()}function C(e){s.show();o.html(`${e}%`);r.css("width",`${e}%`);h.hide()}function q(){s.hide();h.show()}function T(){n.hide();c.show();v.hide()}function D(){n.show();c.hide();v.show()}function M(e){const t=e.value;const a=t.lastIndexOf(".");const i=t.substr(a+1);return"csv"===i}function N(e){if(y){O.toastr.warning("Importing");return}if(!M(e)){O.toastr.error("Please choose a CSV file");return}y=true;C(1);const t=new FormData;t.append("action","pp_upload_csv");t.append("import",e.files[0]);t.append("_ajax_nonce",pp_upload_nonce);O.ajax({type:"POST",url:ajaxurl,data:t,cache:false,processData:false,contentType:false,success:e=>{if(false===e.success){y=false;q();O.toastr.error(e.msg||"Upload failed! Unknown error");return}g.val("");$=0;A(e.data.file)},error(){O.toastr.error("Server error, please try again or refresh the page")}})}function A(t,e=0,a=0){O.ajax({type:"POST",url:ajaxurl,data:{_ajax_nonce:pp_import_nonce,action:"pp_import_csv",file:t,id:e,position:a},success:e=>{$=0;C(e.data.percentage);if(e.data.percentage<100){A(t,e.data.id,e.data.position)}else{y=false;I();setTimeout(()=>{q();L(e.data)},1e3)}},error:()=>{if($<i){$++;setTimeout(()=>A(t,e,a),2e3)}else{O.toastr.error("Server error, please try again or refresh the page")}}})}function I(){const e={action:"pp_tracking_number_import_record",_ajax_nonce:pp_get_history_nonce};O.ajax({type:"GET",url:ajaxurl,data:e,success:e=>{W(e.data)}})}function L(e,t=true){p.html(e.filename);m.html(e.total);_.html(e.succeeded);u.html(e.failed);f.html(e.details.join("<br/>"));if(t){T()}}function W(e){x=e;const a=[];e.forEach(e=>{const t=parcelpanel_admin.strings.import_records.replace("${date}",e.date).replace("${filename}",e.filename).replace("${total}",e.total).replace("${failed}",e.failed);a.push(`<p>${t} <a class="view" data-id="${e.id}">view details.</a></p>`)});l.html(a.join(""));d.show()}});function V(e){e.css("border-color","red")}function z(e){e.css("border-color","")}O.fn.pp_snackbar=e=>{if(!O("body > .pp-snackbars").length){O("body").append("<div class=pp-snackbars></div>")}const t=`<div class=components-snackbar><div class=components-snackbar__content>${e}</div></div>`;const a=O(t);O(".pp-snackbars").append(a);setTimeout(()=>a.remove(),5e3);return this};function E(e,t,a){const i=Math.ceil(Math.random()*1e4);const n=`<div class="components-modal__screen-overlay pp-modal" id="pp-modal-${i}">
<div role="dialog" tabindex="-1" class="components-modal__frame">
<div role="document" class="components-modal__content" style="display: flex; flex-direction: column;">
  <div class="components-modal__header">
    <div class="components-modal__header-heading-container"><h1 class="components-modal__header-heading">${t}</h1></div>
    <button type="button" aria-label="Close dialog" class="components-button has-icon btn-close" style="position: unset; margin-right: -8px;">
      <svg viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.414 10l6.293-6.293a1 1 0 10-1.414-1.414L10 8.586 3.707 2.293a1 1 0 00-1.414 1.414L8.586 10l-6.293 6.293a1 1 0 101.414 1.414L10 11.414l6.293 6.293A.998.998 0 0018 17a.999.999 0 00-.293-.707L11.414 10z" fill="#5C5F62"></path>
      </svg>
    </button>
  </div>
  <div class="pp-modal-body"><p>${e}</p></div>
</div>
<div class="components-modal__footer">
  <button type="button" class="components-button pp-button is-secondary"><span>Cancel</span></button>
  <button type="button" class="components-button pp-button is-primary is-destructive"><span>Confirm</span></button>
</div>
</div>
</div>
`;O("body").append(n);const s=O(`#pp-modal-${i}`);s.on("click",".is-primary",function(){s.remove();a(true)}).on("click",".is-secondary",function(){s.remove();a(false)}).on("click",".btn-close",function(){s.remove();a(false)})}})(jQuery);